{% load static %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Create Product</title>
  <link rel="stylesheet" href="{% static 'styles/products.css' %}">
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>Create Product</h1>

    <form id="product-form">
      <label class="field">
        <span class="label">Product Name</span>
        <input id="name" name="name" required>
      </label>

      <label class="field">
        <span class="label">Price</span>
        <input id="price" name="price" type="number" step="0.01" min="0" required>
      </label>

      <label class="field">
        <span class="label">Category</span>
        <select id="category_id" name="category_id">
          <option value="">-- Select category --</option>
        </select>
      </label>

      <button type="submit">Create</button>
      <p id="message" class="message"></p>
    </form>

    <p class="footnote">
      <a href="/products/list-page">Go to product list â†’</a>
    </p>
  </div>

  <script>
    async function loadCategories() {
      const selectEl = document.getElementById("category_id");
      try {
        const res = await axios.get("/categories");
        const categories = Array.isArray(res.data) ? res.data : (res.data.results || []);
        categories.forEach(cat => {
          const opt = document.createElement("option");
          opt.value = cat.id;
          opt.textContent = cat.name;
          selectEl.appendChild(opt);
        });
      } catch (err) {
        console.error("Failed to load categories:", err);
        const opt = document.createElement("option");
        opt.textContent = "Error loading categories";
        opt.disabled = true;
        selectEl.appendChild(opt);
      }
    }
    loadCategories();

    document.getElementById("product-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const msg = document.getElementById("message");
      msg.textContent = "";

      const name  = document.getElementById("name").value.trim();
      const price = document.getElementById("price").value.trim();
      const category_id = document.getElementById("category_id").value;

      const payload = { name, price };
      if (category_id) payload.category_id = Number(category_id);

      try {
        const res = await axios.post("/products", payload);
        const categoryName = res.data.category ? ` in ${res.data.category.name}` : "";
        msg.textContent = `Created: ${res.data.name} ($${res.data.price})${categoryName}`;
        msg.className = "message success";
        e.target.reset();
      } catch (err) {
        console.error(err);
        const apiErr = err.response?.data;
        msg.textContent =
          apiErr?.name?.[0] || apiErr?.price?.[0] || apiErr?.category_id?.[0] ||
          "Error creating product.";
        msg.className = "message error";
      }
    });
  </script>
</body>
</html>
